# v1.4 Multi-Document Upload Feature - Implementation Complete

**Date**: 2026-01-27
**Feature**: Multi-Document Upload Support (Main Document + PDF Appendices)
**Status**: ✅ Implementation Complete (Pending Testing)

## Summary

Successfully implemented v1.4 multi-document upload feature that enables users to upload a main document plus multiple PDF appendices. This specifically addresses Biomedical Catalyst grant applications where users must submit:
- 400-word text answer (main document - paste text or upload file)
- 2-page PDF appendices (Gantt chart, budget, supporting documents)

The AI evaluation system now processes the concatenated content (main + all appendices) as a single unified document, providing context-aware analysis across all submitted materials.

---

## Changes Made

### 1. Database Layer

#### ✅ Created Migration: `database/migrations/add-appendix-support.sql`
**Purpose**: Add JSONB column to store appendix metadata

**Changes**:
- Added `appendix_files` JSONB column to `document_submissions` table
- Default value: `[]` (empty array for backward compatibility)
- Structure: `[{file_name, s3_key, file_size, upload_order}]`
- Created GIN index on `appendix_files` for efficient JSONB queries
- Added column comment with structure documentation

**SQL**:
```sql
ALTER TABLE document_submissions
ADD COLUMN IF NOT EXISTS appendix_files JSONB DEFAULT '[]';

COMMENT ON COLUMN document_submissions.appendix_files IS
'Array of appendix file metadata: [{file_name, s3_key, file_size, upload_order}]';

CREATE INDEX IF NOT EXISTS idx_submissions_appendix_files
ON document_submissions USING GIN (appendix_files);
```

#### ✅ Created Rollback: `database/migrations/rollback-appendix-support.sql`
**Purpose**: Safe rollback procedure

**SQL**:
```sql
DROP INDEX IF EXISTS idx_submissions_appendix_files;
ALTER TABLE document_submissions DROP COLUMN IF EXISTS appendix_files;
```

**Verification**: Both migrations include DO blocks to verify success/failure

---

### 2. Backend Layer

#### ✅ Modified: `lambda/functions/api/submissions/index.js`

**Changes to Request Handling**:
- Changed parameter from `appendix_files` to `appendices` (frontend sends base64 content)
- Added validation for appendix structure (file_name, file_content, file_size, upload_order)
- Added PDF format validation (only .pdf files allowed)
- Added size validation (max 5MB per appendix)
- Logs: `Creating submission with N appendices`

**Changes to S3 Upload Logic**:
- Upload main document to: `submissions/{userId}/{timestamp}-{document_name}`
- Create submission folder: `submissions/{userId}/{timestamp}/`
- Upload appendices to: `submissions/{userId}/{timestamp}/appendix-N.pdf`
- Convert appendix base64 → Buffer → S3
- Store appendix metadata: `{file_name, s3_key, file_size, upload_order}`
- Graceful error handling: Fail entire request if any appendix upload fails

**Changes to Database Insert**:
- Store `appendixMetadata` array as JSONB in `appendix_files` column
- Pass `submissionId` to Step Functions workflow for AI agents

**Lines Modified**: ~103-202 (100 lines)

---

#### ✅ Modified: `lambda/layers/common/nodejs/db-utils.js`

**Added Function**: `getDocumentWithAppendices(dbClient, submissionId, s3Bucket, s3Key)`

**Purpose**: Concatenate main document + all appendices into single text for AI processing

**Logic**:
1. Extract main document text using `getDocumentFromS3()`
2. Query database for `appendix_files` JSONB array
3. If no appendices, return main text (backward compatible)
4. For each appendix (in upload order):
   - Extract text from S3 using `getDocumentFromS3()`
   - Add separator: `\n\n---APPENDIX N: filename---\n\n`
   - Append appendix text
   - Handle errors gracefully (continue with remaining appendices)
5. Return combined text with total character count logged

**Separator Format**:
```
Main document content here...

---APPENDIX 1: gantt-chart.pdf---

Appendix 1 content here...

---APPENDIX 2: budget-breakdown.pdf---

Appendix 2 content here...
```

**Logging**:
- `[Multi-Doc] Extracting text for submission: {submissionId}`
- `[Multi-Doc] Main document extracted: {length} characters`
- `[Multi-Doc] Uploaded appendix N: {s3_key}`
- `[Multi-Doc] Text concatenation complete: {total_length} chars total`

**Export**: Added to `module.exports`

**Lines Added**: ~356-408 (52 lines)

---

#### ✅ Modified AI Agents (3 files)

**Pattern Applied to Each Agent**:
1. Add `getDocumentWithAppendices` to require statement
2. Add `submissionId` to event destructuring (if not present)
3. Replace `getDocumentFromS3()` call with `getDocumentWithAppendices()`
4. Update console.log to indicate "with appendices"

**Files Modified**:

1. **`lambda/functions/structure-validator/index.js`**
   - Line 12: Added import
   - Line 21: Added submissionId parameter (already present)
   - Line 60: Changed to `getDocumentWithAppendices(dbClient, submissionId, s3Bucket, s3Key)`
   - Line 61: Updated log message

2. **`lambda/functions/content-analyzer/index.js`**
   - Line 7-12: Added import
   - Line 20: Added submissionId parameter
   - Line 44: Changed to `getDocumentWithAppendices(dbClient, submissionId, s3Bucket, s3Key)`
   - Line 45: Updated log message

3. **`lambda/functions/grammar-checker/index.js`**
   - Line 7: Added import
   - Line 17: Added submissionId parameter
   - Line 23: Changed to `getDocumentWithAppendices(dbClient, submissionId, s3Bucket, s3Key)`

**Agents Not Modified** (Verified - No changes needed):
- **clarification**: Uses analysis results from previous agents, doesn't read document from S3
- **scoring**: Uses analysis results from previous agents, doesn't read document from S3

---

### 3. Frontend Layer

#### ✅ Modified: `frontend/lib/api-client.ts`

**Changes to createSubmission() Type**:
```typescript
async createSubmission(data: {
  session_id: string;
  overlay_id: string;
  document_name: string;
  document_content: string;
  file_size?: number;
  is_pasted_text?: boolean;
  appendices?: Array<{           // NEW
    file_name: string;
    file_content: string;        // base64
    file_size: number;
    upload_order: number;
  }>;
})
```

**Lines Modified**: 137-148

---

#### ✅ Modified: `frontend/app/session/[id]/page.tsx`

**New State Variables**:
```typescript
const [appendixFiles, setAppendixFiles] = useState<File[]>([]);
const [appendixError, setAppendixError] = useState<string | null>(null);
```

**New Icons Imported**:
- `Paperclip` - for appendix UI
- `X` - for remove button

**New Functions Added**:

1. **`handleAppendixSelect(event)`**:
   - Handles multiple file selection
   - Validates PDF format
   - Validates 5MB size limit per file
   - Shows errors for invalid files
   - Adds valid files to appendixFiles array
   - Resets input after selection

2. **`removeAppendix(index)`**:
   - Removes appendix from list by index
   - Clears errors

**Modified Function**:

**`handleUpload()`**:
- Reads all appendix files as base64
- Creates appendicesData array with structure: `{file_name, file_content, file_size, upload_order}`
- Passes appendices to `createSubmission()` API call
- Clears appendixFiles after successful upload
- Updates success message to include appendix count: `"file.txt (+2 appendices)"`

**New UI Components** (lines ~470-570):

```tsx
{/* Main Document Section */}
<label>Main Document</label>
<div className="border-dashed...">
  {/* Existing upload UI */}
</div>

{/* NEW: Appendices Section */}
<div>
  <label>Appendices (Optional)</label>
  <span>PDF only, max 5MB each</span>

  {/* Error display */}
  {appendixError && <Alert variant="destructive">...</Alert>}

  {/* Upload area */}
  <div className="border-dashed...">
    <input type="file" accept=".pdf" multiple />
    <Paperclip icon />
    <p>Add PDF appendices</p>
    <p>e.g., Gantt charts, budgets, supporting documents</p>
  </div>

  {/* Display selected files */}
  {appendixFiles.map((file, index) => (
    <div className="flex items-center justify-between">
      <Paperclip icon />
      <span>{file.name}</span>
      <span>({file.size} KB)</span>
      <Button onClick={() => removeAppendix(index)}>
        <X icon />
      </Button>
    </div>
  ))}
</div>

{/* Upload button shows appendix count */}
<Button>
  Upload Document{appendixFiles.length > 0 ? ` (+N appendices)` : ''}
</Button>
```

**Lines Modified**: ~62-586 (100+ lines added)

---

#### ✅ Modified: `frontend/app/submission/[id]/page.tsx`

**New Icons Imported**:
- `Paperclip` - for appendix display
- `Download` - for download button

**New UI Section** (lines ~253-296):

```tsx
{/* Appendices Section */}
{submission.appendix_files && submission.appendix_files.length > 0 && (
  <Card className="mb-6">
    <CardHeader>
      <CardTitle>
        <Paperclip /> Appendices ({submission.appendix_files.length})
      </CardTitle>
      <CardDescription>
        Additional documents submitted with the main document
      </CardDescription>
    </CardHeader>
    <CardContent>
      {submission.appendix_files.map((appendix, index) => (
        <div className="flex items-center justify-between bg-slate-50...">
          <Paperclip icon />
          <div>
            <p>{appendix.file_name}</p>
            <p>{appendix.file_size / 1024} KB • Appendix {appendix.upload_order}</p>
          </div>
          <Button variant="outline" size="sm">
            <Download /> Download
          </Button>
        </div>
      ))}
    </CardContent>
  </Card>
)}
```

**Placement**: Added right after header, before AI Analysis Status section

**Backward Compatibility**: Only displays if `appendix_files` array exists and has length > 0

**Lines Modified**: 13-296 (44 lines added)

---

## File Summary

### Files Created (2):
1. ✅ `database/migrations/add-appendix-support.sql` - 30 lines
2. ✅ `database/migrations/rollback-appendix-support.sql` - 25 lines

### Files Modified (7):
1. ✅ `lambda/functions/api/submissions/index.js` - ~100 lines modified
2. ✅ `lambda/layers/common/nodejs/db-utils.js` - +52 lines (new function)
3. ✅ `lambda/functions/structure-validator/index.js` - 4 lines modified
4. ✅ `lambda/functions/content-analyzer/index.js` - 5 lines modified
5. ✅ `lambda/functions/grammar-checker/index.js` - 3 lines modified
6. ✅ `frontend/lib/api-client.ts` - 11 lines modified
7. ✅ `frontend/app/session/[id]/page.tsx` - +100 lines (new UI)
8. ✅ `frontend/app/submission/[id]/page.tsx` - +44 lines (new UI)

### Total Code Changes:
- **Lines Added**: ~374 lines
- **Lines Modified**: ~123 lines
- **Total Impact**: ~497 lines of code

---

## Key Design Decisions

### 1. **JSONB Column Type**
- **Why**: Flexible schema allows adding metadata fields later without migrations
- **Example**: Could add `content_type`, `extracted_text_length`, `processing_status` in future

### 2. **Base64 Transport in Frontend → Backend**
- **Why**: REST API standard for binary file data in JSON
- **Alternative Considered**: Presigned S3 URLs (would require 2-step upload)
- **Trade-off**: Larger payload size (+33%) but simpler implementation

### 3. **S3 Folder Structure**
- **Pattern**: `submissions/{userId}/{timestamp}/appendix-N.pdf`
- **Why**: Groups related files together, easy to clean up, timestamp ensures uniqueness
- **Alternative Considered**: Flat structure with UUIDs (harder to manage)

### 4. **Text Concatenation with Separators**
- **Format**: `---APPENDIX N: filename---`
- **Why**: Clear visual boundary for AI, includes filename for context
- **Benefits**: AI can identify which appendix contains specific information

### 5. **Error Handling Strategy**
- **Validation**: Frontend validates PDF format + 5MB limit before upload
- **Backend**: Re-validates and fails entire request if any appendix upload fails
- **Why**: Atomic operation - either all files succeed or none do (data consistency)

### 6. **Backward Compatibility**
- **Database**: Default value `[]` for existing rows
- **Backend**: `getDocumentWithAppendices()` falls back to main document if no appendices
- **Frontend**: Conditional rendering only shows appendix section if array exists

### 7. **Upload Order Preservation**
- **Why**: Important for Biomedical Catalyst applications (specific order required)
- **Implementation**: Frontend assigns `upload_order: 1, 2, 3...`, backend respects order during concatenation
- **Display**: Shows "Appendix N" in UI for clarity

---

## API Contract

### Request: POST /submissions

**Before v1.4**:
```json
{
  "session_id": "uuid",
  "overlay_id": "uuid",
  "document_name": "file.txt",
  "document_content": "base64...",
  "file_size": 1024
}
```

**After v1.4**:
```json
{
  "session_id": "uuid",
  "overlay_id": "uuid",
  "document_name": "file.txt",
  "document_content": "base64...",
  "file_size": 1024,
  "appendices": [                    // NEW (optional)
    {
      "file_name": "gantt.pdf",
      "file_content": "base64...",   // base64 encoded PDF
      "file_size": 245000,           // bytes
      "upload_order": 1
    },
    {
      "file_name": "budget.pdf",
      "file_content": "base64...",
      "file_size": 189000,
      "upload_order": 2
    }
  ]
}
```

### Response: GET /submissions/{id}

**Before v1.4**:
```json
{
  "submission_id": "uuid",
  "document_name": "file.txt",
  "s3_key": "submissions/.../file.txt",
  "status": "submitted",
  ...
}
```

**After v1.4**:
```json
{
  "submission_id": "uuid",
  "document_name": "file.txt",
  "s3_key": "submissions/.../file.txt",
  "status": "submitted",
  "appendix_files": [                // NEW
    {
      "file_name": "gantt.pdf",
      "s3_key": "submissions/.../appendix-1.pdf",
      "file_size": 245000,
      "upload_order": 1
    },
    {
      "file_name": "budget.pdf",
      "s3_key": "submissions/.../appendix-2.pdf",
      "file_size": 189000,
      "upload_order": 2
    }
  ],
  ...
}
```

---

## Testing Plan

### ⏳ Pending Tests

#### 1. Database Migration Test
```bash
# Run migration
psql -h <aurora-endpoint> -U admin -d overlay_db -f database/migrations/add-appendix-support.sql

# Verify column exists
SELECT column_name, data_type, column_default
FROM information_schema.columns
WHERE table_name = 'document_submissions'
AND column_name = 'appendix_files';

# Verify index exists
SELECT indexname FROM pg_indexes
WHERE tablename = 'document_submissions'
AND indexname = 'idx_submissions_appendix_files';
```

#### 2. Multi-File Upload Test (End-to-End)
**Steps**:
1. Start frontend: `npm run dev` (in frontend directory)
2. Start proxy: `node proxy-server.js` (in frontend directory)
3. Login as admin@example.com
4. Navigate to any session
5. Upload main document (txt/pdf)
6. Add 2 PDF appendices (< 5MB each)
7. Click "Upload Document (+2 appendices)"
8. Verify success dialog shows
9. Check S3 bucket for 3 files:
   - `submissions/{userId}/{timestamp}-main.txt`
   - `submissions/{userId}/{timestamp}/appendix-1.pdf`
   - `submissions/{userId}/{timestamp}/appendix-2.pdf`
10. Check database: `appendix_files` JSONB contains 2 entries
11. Navigate to submission detail page
12. Verify appendices section displays 2 files
13. Check CloudWatch logs for AI agents:
    - structure-validator should log "Document fetched (with appendices)"
    - Text length should be main + separator + appendix1 + separator + appendix2

#### 3. Backward Compatibility Test
**Steps**:
1. Find existing submission (created before v1.4) in database
2. Verify `appendix_files` column shows `[]` (empty array)
3. Navigate to submission detail page
4. Verify NO appendices section displays (conditional rendering)
5. Trigger AI workflow for old submission
6. Verify AI agents process only main document (no errors)
7. Verify `getDocumentWithAppendices()` returns only main text

#### 4. Validation Tests

**Test 4a: Non-PDF Appendix**:
- Try uploading `.docx` as appendix
- Expected: Error message "must be a PDF file"

**Test 4b: Oversized Appendix**:
- Try uploading 6MB PDF
- Expected: Error message "exceeds 5MB limit (6.00MB)"

**Test 4c: Multiple Valid Appendices**:
- Upload 5 PDFs (each 1MB)
- Expected: All 5 display in list, upload succeeds

**Test 4d: Remove Appendix**:
- Add 3 appendices, click X on middle one
- Expected: Only 2 remain, order preserved

#### 5. Integration Test
```bash
# Run full integration test suite
node scripts/test-api-endpoints.js

# Expected: 9/9 tests pass
# - Must include new appendix scenarios
```

---

## Known Limitations

### 1. Download Functionality
- **Status**: Not Implemented
- **Reason**: Requires presigned S3 URL generation in backend
- **Workaround**: Download button shows "Coming soon" toast
- **TODO**: Add `/submissions/{id}/download-appendix/{order}` endpoint

### 2. Text Extraction from PDFs
- **Current**: `getDocumentFromS3()` extracts text from PDFs using existing logic
- **Limitation**: May not work for scanned PDFs (OCR needed)
- **Impact**: AI may not see content of scanned appendices

### 3. Appendix Order Re-arrangement
- **Current**: Upload order is fixed (1, 2, 3...)
- **Limitation**: Cannot drag-and-drop to reorder before upload
- **Workaround**: Remove and re-add in desired order

### 4. Appendix Size Validation
- **Frontend**: Validates 5MB limit
- **Backend**: Also validates (defense in depth)
- **Limitation**: No warning when approaching limit, only hard failure

---

## Success Criteria

### ✅ Implementation Checklist

- [x] Database migration created with JSONB column
- [x] Rollback migration created for safety
- [x] Backend validates PDF format
- [x] Backend validates 5MB size limit
- [x] Backend uploads appendices to S3 with proper naming
- [x] Backend stores metadata in database
- [x] db-utils.js concatenates text with separators
- [x] 3 AI agents updated to use new function (structure, content, grammar)
- [x] 2 AI agents verified as not needing changes (clarification, scoring)
- [x] Frontend displays appendix upload UI
- [x] Frontend validates files before upload
- [x] Frontend displays uploaded appendices with remove button
- [x] Submission detail page shows appendix list
- [x] Backward compatibility maintained (old submissions work)
- [x] No changes to existing API routes or database tables (other than new column)

### ⏳ Testing Checklist

- [ ] Database migration test passed
- [ ] Multi-file upload test passed (end-to-end)
- [ ] Backward compatibility test passed
- [ ] File validation tests passed (4 scenarios)
- [ ] Integration tests passed (9/9)
- [ ] CloudWatch logs show correct text concatenation
- [ ] AI agents process concatenated text correctly

---

## Deployment Steps

### 1. Database Migration
```bash
# Connect to Aurora PostgreSQL
psql -h <aurora-endpoint> -U admin -d overlay_db

# Run migration
\i database/migrations/add-appendix-support.sql

# Verify success
SELECT column_name FROM information_schema.columns
WHERE table_name = 'document_submissions' AND column_name = 'appendix_files';
```

### 2. Deploy Backend Changes
```bash
# Deploy Lambda Layer (db-utils.js updated)
cd lambda/layers/common
npm install
cd ../../..
cdk deploy OrchestrationStack --require-approval never

# Deploy Lambda functions
cdk deploy ComputeStack --require-approval never
```

### 3. Deploy Frontend Changes
```bash
cd frontend
npm run build
# Deploy to Vercel/Amplify/S3+CloudFront
```

### 4. Smoke Test
- Login to production
- Upload test document with 2 appendices
- Verify AI analysis completes
- Check submission detail page shows appendices

---

## Rollback Plan

### If Issues Found After Deployment:

**Step 1**: Revert Backend Code
```bash
git revert <commit-hash>
cdk deploy ComputeStack --require-approval never
```

**Step 2**: Revert Frontend Code
```bash
git revert <commit-hash>
npm run build && <deploy>
```

**Step 3**: Rollback Database (Optional)
```bash
psql -h <aurora-endpoint> -U admin -d overlay_db
\i database/migrations/rollback-appendix-support.sql
```

**Note**: Database rollback will delete `appendix_files` column and all appendix metadata. Only run if absolutely necessary.

---

## Future Enhancements

### v1.5 Potential Features:

1. **Download Appendix** - Implement presigned S3 URLs
2. **Drag-and-Drop Reorder** - Allow users to rearrange appendix order
3. **File Type Support** - Add support for DOCX appendices (with text extraction)
4. **Appendix Preview** - Show PDF preview thumbnails in UI
5. **Bulk Delete** - "Remove All" button for appendices
6. **Progress Indicators** - Show upload progress per appendix
7. **OCR Support** - Extract text from scanned PDFs
8. **Appendix-Specific Feedback** - AI provides feedback per appendix in addition to overall
9. **Version Control** - Track appendix replacements/updates
10. **Appendix Templates** - Pre-fill common appendix types (Gantt, budget, etc.)

---

## Questions for Review

1. Should we add a maximum appendix count limit? (e.g., max 5 appendices)
2. Should we allow re-ordering appendices before upload via drag-and-drop?
3. Should download functionality be prioritized for v1.4 or deferred to v1.5?
4. Should we add a total size limit (e.g., main + all appendices < 25MB)?
5. Should we log appendix upload metrics to CloudWatch for monitoring?

---

## Contact

**Implemented By**: Claude Code (AI Assistant)
**Review Requested**: Development Team
**Next Steps**: Execute testing plan, deploy to staging, then production

---

*End of v1.4 Implementation Report*
